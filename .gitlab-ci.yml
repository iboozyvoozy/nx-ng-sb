stages:
  - build

default:
  image: 'registry.nimbusweb.co/docker/nimbus-node:16.2'

build:strict:
  stage: build
  cache:
    key:
      prefix: 'strict-cache'
      files:
        - package-lock.json
    paths:
      - tmp/nx
      - tmp/npm
  artifacts:
    paths:
      - dist
  script:
    - 'node -v && npm -v'
    - 'npm ci --cache=tmp/npm'
    - 'npm run nx run-many -- --all --target=lint'
    - 'npm run nx run-many -- --all --target=test'
    - 'npm run nx run-many -- --all --target=build'
    - 'npm run nx run-many -- --all --target=build-storybook'
    - 'npm run dep-graph -- --file=dist/dep-graph/index.html'

build:fast:
  stage: build
  cache:
    key:
      prefix: 'fast-cache'
      files:
        - package-lock.json
    paths:
      - tmp/nx
      - tmp/npm
      - node_modules
  artifacts:
    paths:
      - dist
  script:
    - 'node -v && npm -v'
    - 'npm i --cache=tmp/npm'
    - 'npm run nx run-many -- --all --target=lint'
    - 'npm run nx run-many -- --all --target=test'
#    - 'npm run nx run-many -- --all --target=build'
    - 'npm run nx build api'
    - 'npm run nx build client'
    - 'npm run nx build-storybook ui-kit'
    - 'npm run nx run-many -- --all --target=build-storybook'
    - 'npm run dep-graph -- --file=dist/dep-graph/index.html'
    - 'git add -A && git diff --cached'
